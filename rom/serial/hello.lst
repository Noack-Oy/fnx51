                   
                   ; *********************************
                   ; * Serial Interface Test Program *
                   ; *********************************
                   
                   ; This program prints "Hello, world!"
                   
                   
                   ; **********************
                   ; * Header Definitions *
                   ; **********************
                   
                   ; *** serial/sfr.equ ***
                   
                   ; Special function registers for serial interface.
                   ; See chapter 14 of AT89C51ED2 datasheet, page 48ff.
                   
                   ; Internal Baud Rate Generator (BRG), see datasheet page 52.
0000:                       .equ    BRL,    0x9A    ; baud rate reload value
0000:                       .equ    BDRCON, 0x9B    ; BRG control register
                   
                   
                   ; *************
                   ; * Main Code *
                   ; *************
                   
                   ; *** serial/hello.asm ***
                   
0000:                       .org    0
                   
0000: 11 1F                 acall   serial_init
                   
0002: 90 00 11              mov     DPTR,   #hello_text
                   hello_loop:
0005: 74 00                 mov     a,      #0
0007: 93                    movc    a,      @DPTR+a
0008: 60 05                 jz      hello_end
000A: 11 29                 acall   serial_tx
000C: A3                    inc     dptr
000D: 01 05                 ajmp    hello_loop
                   
                   hello_end:
000F: 01 0F                 ajmp    *
                   
                   hello_text:
0011: 48 65 6C 6C 
      6F 2C 20 77 
      6F 72 6C 64 
      21                    .byte   "Hello, world!"
001E: 00                    .byte   0
                   
                   
                   ; *********************
                   ; * Library Functions *
                   ; *********************
                   
                   ; *** serial/init.inc ***
                   
                   ; >> void serial_init() <<
                   
                   ; Initialize serial interface.
                   ; - assumes 20MHz clock and X2 mode
                   ; - uses internal baud rate generator
                   ; - speed: 9600 bits per second
                   ; Formula: BRL = 256 - (F_clk / (32 * Baud_Rate))
                   ; ---
                   ; See datasheet page 52 for details,
                   ; also note oscillator diagram on page 16!
                   
                   serial_init:
001F: 75 98 52              mov     SCON,   #0x52   ; SM1, REN, TI
0022: 75 9A BF              mov     BRL,    #191    ; 9600 @20MHz CLK
0025: 75 9B 1E              mov     BDRCON, #0x1e   ; BRR, RBCK, TBCK, SPD
0028: 22                    ret
                   
                   ; *** serial/tx.inc ***
                   
                   ; >> void serial_tx(char a) <<
                   
                   ; Transmit byte from accumulator.
                   
                   serial_tx:
0029: 30 99 FD              jnb     TI,     serial_tx
002C: C2 99                 clr     TI
002E: F5 99                 mov     SBUF,   a
0030: 22                    ret
